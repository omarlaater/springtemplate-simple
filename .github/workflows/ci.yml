name: ci

on:
  pull_request:
  push:
    branches: [main]

permissions:
  contents: read
  pull-requests: write
  packages: write

env:
  JAVA_VERSION: "17"
  IMAGE_NAME: ghcr.io/${{ github.repository }}

jobs:
  unit-static:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: ${{ env.JAVA_VERSION }}
          cache: maven

      - name: Unit tests + static analysis + JaCoCo
        run: mvn -B -ntp clean verify

      - name: Upload JaCoCo report
        uses: actions/upload-artifact@v4
        with:
          name: jacoco-report
          path: target/site/jacoco

      - name: Dependency vulnerability scan (OWASP)
        run: mvn -B -ntp org.owasp:dependency-check-maven:check -DfailBuildOnCVSS=7

      - name: Generate SBOM
        run: mvn -B -ntp org.cyclonedx:cyclonedx-maven-plugin:makeAggregateBom

  sonar:
    runs-on: ubuntu-latest
    needs: unit-static
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: ${{ env.JAVA_VERSION }}
          cache: maven

      # Replace with your Conjur action/integration.
      # This placeholder expects SONAR_TOKEN to be injected by your CI secret broker.
      - name: Sonar scan + quality gate (blocking)
        env:
          SONAR_HOST_URL: ${{ vars.SONAR_HOST_URL }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        run: >
          mvn -B -ntp verify sonar:sonar
          -Dsonar.host.url=${SONAR_HOST_URL}
          -Dsonar.token=${SONAR_TOKEN}
          -Dsonar.qualitygate.wait=true

  integration-tests:
    runs-on: ubuntu-latest
    needs: unit-static
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: ${{ env.JAVA_VERSION }}
          cache: maven

      - name: Integration tests (Testcontainers + Liquibase)
        run: mvn -B -ntp verify -Pintegration-tests

  build-and-publish-image:
    runs-on: ubuntu-latest
    needs: [sonar, integration-tests]
    if: github.ref == 'refs/heads/main'
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push immutable image
        uses: docker/build-push-action@v6
        with:
          context: .
          push: true
          tags: |
            ${{ env.IMAGE_NAME }}:${{ github.sha }}
            ${{ env.IMAGE_NAME }}:main

      - name: Container image scan (Trivy)
        uses: aquasecurity/trivy-action@0.24.0
        with:
          image-ref: ${{ env.IMAGE_NAME }}:${{ github.sha }}
          format: table
          exit-code: "1"
          ignore-unfixed: true
          severity: CRITICAL,HIGH

  promote-gitops:
    runs-on: ubuntu-latest
    needs: build-and-publish-image
    if: github.ref == 'refs/heads/main'
    steps:
      - name: Checkout GitOps repo
        uses: actions/checkout@v6
        with:
          repository: your-org/your-gitops-repo
          token: ${{ secrets.GITOPS_REPO_TOKEN }}
          path: gitops

      - name: Update image tag
        working-directory: gitops
        run: |
          # Example path; adjust to your repo structure.
          sed -i "s/newTag:.*/newTag: ${GITHUB_SHA}/" apps/spring-template-starter/k8s/app/overlays/dev/kustomization.yaml

      - name: Create promotion PR
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITOPS_REPO_TOKEN }}
          path: gitops
          branch: chore/promote-spring-template-${{ github.sha }}
          title: "Promote spring-template-starter image ${{ github.sha }}"
          body: "Automated promotion PR from app CI pipeline."
          commit-message: "chore: promote spring-template-starter to ${{ github.sha }}"

  smoke-test:
    runs-on: ubuntu-latest
    needs: promote-gitops
    if: github.ref == 'refs/heads/main'
    steps:
      - name: Smoke tests (placeholder)
        run: |
          echo "Implement environment smoke checks:"
          echo "1) /actuator/health"
          echo "2) create/get product CRUD path"
